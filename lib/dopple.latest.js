"use strict";function isSpace(e){return" "==e||"	"==e||"\r"==e||"\n"==e}function isNewline(e){return"\r"===e||"\n"===e}function isDigit(e){return e>="0"&&"9">=e||"."===e}function isAlpha(e){return e>="a"&&"z">=e||e>="A"&&"Z">=e||"_"==e&&"$">=e}function isAlphaNum(e){return e>="a"&&"z">=e||e>="A"&&"Z">=e||e>="0"&&"9">=e||"_"===e||"$"===e}function isBinOp(e){return"="===e||"<"===e||">"===e||"+"===e||"-"===e||"*"===e||"/"===e}function ToHex(e){return"\\x"+e.toString(16)}function isIllegal(e){return"@"===e}function Token(){this.type=0,this.str="",this.value=0}function Tokenizer(){this.buffer="",this.bufferLength=0,this.cursor=0,this.currChar="",this.token=new Token}function Lexer(){this.tokenizer=new Tokenizer,this.token=null,this.prevToken=null,this.optimizer=new Optimizer,this.precedence={"=":2,"<":100,">":100,"+":200,"-":200,"*":400,"/":400},this.global=new dopple.Scope,this.scope=this.global,this.genID=0,this.currName="",this.currVar=null,this.parentList=null,this._skipNextToken=!1,this.tokenEnum=Token.Type,this.varEnum=Variable.Type,this.exprEnum=Expression.Type}function Optimizer(){this.exprEnum=Expression.Type}function Compiler(){this.lexer=null,this.createLexer(),this.varMap={},this.varMap[Variable.Type.VOID]="void ",this.varMap[Variable.Type.NUMBER]="double ",this.varMap[Variable.Type.BOOL]="int32_t ",this.varMap[Variable.Type.STRING]="const char *",this.varMap[Variable.Type.STRING_OBJ]="char *",this.tabs="",this.output="",this.global=this.lexer.global,this.scope=null,this.exprEnum=Expression.Type,this.varEnum=Variable.Type}var dopple={compile:function(e){var t=new Compiler;return t.compile(e)}};"undefined"!=typeof exports?(dopple.isNodeJS=!0,module.exports.dopple=dopple):dopple.isNodeJS=!1,"use strict",dopple.Error={REFERENCE_ERROR:1,UNEXPECTED_TOKEN:2,UNEXPECTED_TOKEN_ILLEGAL:3,UNEXPECTED_EOI:4,UNEXPECTED_NUMBER:5,UNEXPECTED_ID:6,INVALID_REGEXP:10,REDEFINITION:100,INVALID_TYPE_CONVERSION:1e3,TOO_MANY_ARGUMENTS:1001,UNSUPPORTED_FEATURE:1002},dopple.throw=function(e,t){if(e===this.Error.REFERENCE_ERROR)throw"ReferenceError: "+t+" is not defined";if(e===this.Error.UNEXPECTED_TOKEN)throw"SyntaxError: Unexpected token "+t;if(e===this.Error.UNEXPECTED_TOKEN_ILLEGAL)throw"SyntaxError: Unexpected token ILLEGAL";if(e===this.Error.UNEXPECTED_EOI)throw"SyntaxError: Unexpected end of input";if(e===this.Error.UNEXPECTED_NUMBER)throw"SyntaxError: Unexpected number";if(e===this.Error.UNEXPECTED_ID)throw"SyntaxError: Unexpected identifier";if(e===this.Error.INVALID_REGEXP)throw"SyntaxError: Invalid regular expression: missing "+t;if(e===this.Error.REDEFINITION)throw"Redefined: "+t;if(e===this.Error.INVALID_TYPE_CONVERSION)throw"Invalid Type Conversion: "+t;if(e===this.Error.TOO_MANY_ARGUMENTS)throw"Too many arguments passed.";if(e===this.Error.UNSUPPORTED_FEATURE)throw'Unsupported feature used: "'+t+'"';throw"Unknown"},"use strict","use strict",Token.Type={EOF:0,SYMBOL:-10,BINOP:-11,NUMBER:-12,BOOL:-13,NAME:-14,STRING:-15,VAR:-20,RETURN:-21,FUNCTION:-22,COMMENT:-30},"use strict",Tokenizer.prototype={setBuffer:function(e){this.buffer=e,this.bufferLength=e.length,this.cursor=0,this.currChar=""},nextToken:function(){for(this.token.type=0,this.token.str="",this.token.value=0,this.nextChar();isSpace(this.currChar);)this.nextChar();if(isAlpha(this.currChar)){for(this.token.str+=this.currChar,this.nextChar();isAlphaNum(this.currChar);)this.token.str+=this.currChar,this.nextChar();return this.cursor--,"var"===this.token.str?this.token.type=Token.Type.VAR:"return"===this.token.str?this.token.type=Token.Type.RETURN:"function"===this.token.str?this.token.type=Token.Type.FUNCTION:"true"===this.token.str?(this.token.type=Token.Type.BOOL,this.token.value=1):"false"===this.token.str?this.token.type=Token.Type.BOOL:"NaN"===this.token.str?(this.token.type=Token.Type.NUMBER,this.token.value=0/0):this.token.type=Token.Type.NAME,this.token}if(isDigit(this.currChar)){for(this.token.str+=this.currChar,this.nextChar();isDigit(this.currChar);)this.token.str+=this.currChar,this.nextChar();return this.cursor--,"."===this.token.str?(this.token.type=Token.Type.SYMBOL,this.token.value=this.token.str,this.token):(this.token.type=Token.Type.NUMBER,this.token.value=parseFloat(this.token.str),this.token)}if(isBinOp(this.currChar)){if(this.token.str=this.currChar,"-"===this.currChar){if(this.nextChar(),isDigit(this.currChar)){for(;isDigit(this.currChar);)this.token.str+=this.currChar,this.nextChar();return this.token.value=parseFloat(this.token.str),this.token.type=Token.Type.NUMBER,this.cursor--,this.token}this.cursor--}else if("/"===this.currChar){if(this.nextChar(),"/"===this.currChar)return this.skipUntilNewline(),this.token.type=Token.Type.COMMENT,this.token;if("*"===this.currChar)return this.skipUntil("/"),this.token.type=Token.Type.COMMENT,this.token;this.cursor--}return this.token.type=Token.Type.BINOP,this.token}if('"'===this.currChar||"'"===this.currChar){var e=this.currChar;for(this.nextChar();this.currChar!==e;){if("\x00"===this.currChar)throw dopple.throw(dopple.Error.UNEXPECTED_EOI);this.token.str+=this.currChar,this.nextChar()}return this.token.type=Token.Type.STRING,this.token}return"\x00"===this.currChar?(this.token.type=Token.Type.EOF,this.token):(this.token.type=Token.Type.SYMBOL,this.token.str=this.currChar,this.token)},nextChar:function(e){this.currChar=this.cursor>=this.bufferLength?"\x00":this.buffer.charAt(this.cursor),this.cursor++},readUntil:function(e){var t="";for(this.nextChar();this.currChar!==e&&"\x00"!==this.currChar;)"\\"===this.currChar&&(t+="\\",this.nextChar()),t+=this.currChar,this.nextChar();return t},skipUntil:function(e){for(this.nextChar();this.currChar!==e&&"\x00"!==this.currChar;)this.nextChar()},skipUntilNewline:function(){for(this.nextChar();"\r"!==this.currChar&&"\n"!==this.currChar&&"\x00"!==this.currChar;)this.nextChar()}},"use strict",Lexer.prototype={read:function(e){return this.tokenizer.setBuffer(e),this.parseBody(),!0},nextToken:function(){this.token=this.tokenizer.nextToken()},getTokenPrecendence:function(){if(this.token.type!==Token.Type.BINOP)return-1;var e=this.precedence[this.token.str];return void 0===e?-1:e},parseBody:function(){var e,t=Token.Type;do this._skipNextToken?this._skipNextToken=!1:this.nextToken(),e=this.token.type,e===t.NAME||e===t.VAR?this.parseVar():e===t.FUNCTION?this.parseFunc():e===t.RETURN&&this.parseReturn();while(this.token.type!==t.EOF&&"}"!==this.token.str)},parseExpression:function(){var e=this.parsePrimary();return e?this.parseBinOpRHS(0,e):null},parseBinOpRHS:function(e,t){for(;;){var r=this.getTokenPrecendence();if(e>r)return t;var s=this.token.str;this.nextToken();var i=this.parsePrimary();if(!i)return null;var n=this.getTokenPrecendence();if(n>r&&(i=this.parseBinOpRHS(r+1,i),!i))return null;t=new Expression.Binary(s,t,i)}return t},parsePrimary:function(){return this.token.type===Token.Type.NUMBER?this.parseNumber():this.token.type===Token.Type.NAME?this.parseName():this.token.type===Token.Type.STRING?this.parseString():this.token.type===Token.Type.BOOL?this.parseBool():this.token.type===Token.Type.FUNCTION?this.parseFunc():"{"===this.token.str?this.parseObject():(this.handleTokenError(),void 0)},parseNumber:function(){var e=new Expression.Number(this.token.value);return this.nextToken(),e},parseBool:function(){var e=new Expression.Bool(this.token.value);return this.nextToken(),e},parseName:function(){var e=this.scope.vars[this.token.str];e||dopple.throw(dopple.Error.REFERENCE_ERROR,this.token.str);var t=new Expression.Var(this.token.str);return t.expr=t,t.var=e,t.type=e.type,t.value=this.token.str,this.nextToken(),t},parseString:function(){var e=new Expression.StringObj(this.token.str);return this.nextToken(),e},parseVar:function(){var e=!1;if(this.token.type===Token.Type.VAR&&(this.nextToken(),this.token.type!==Token.Type.NAME&&this.handleTokenError(),e=!0),this.currName=this.token.str,this.nextToken(),"("===this.token.str)this.parseFuncCall();else if("."===this.token.str){if(e&&dopple.throw(dopple.Error.UNEXPECTED_TOKEN,this.token.str),this.parseParentList(),"="===this.token.str)this._defineObjectVar();else{if("("!==this.token.str)throw"Lexer::parseVar: Unhandled case!";this.parseFuncCall()}this.parentList=null}else if("="===this.token.str){this.nextToken();var t=this.parseExpression();t.exprType!==this.exprEnum.OBJECT&&t.exprType!==this.exprEnum.FUNCTION&&this._defineVar(t,e)}else e||this.token.type!==this.tokenEnum.NAME?e&&this.token.type===this.tokenEnum.SYMBOL&&this.handleUnexpectedToken():this.handleTokenError(),this._defineVar(null,e);this.currName=""},_defineVar:function(e,t){if(!e&&!t)return this.getExprFromVar(this.scope,this.currName),void 0;var r=new Expression.Var(this.currName,this.parentList),s=this.scope.vars[this.currName],i=!1;if(e&&e.exprType===this.exprEnum.FUNCTION?s&&dopple.throw(dopple.Error.UNSUPPORTED_FEATURE,"Redefining function pointer"):(void 0===s?(t||dopple.throw(dopple.Error.REFERENCE_ERROR,this.currName),i=!0,s=r,this.scope.vars[this.currName]=r,this.scope.defBuffer.push(r)):this.scope.varBuffer.push(r),r.var=s),e){if(e=this.optimizer.do(e),r.expr=e,r.analyse(),i&&this.scope===this.global){var n=r.expr.exprType;(n===this.exprEnum.BINARY||n===this.exprEnum.VAR)&&this.scope.varBuffer.push(r)}";"!==this.token.str&&(this._skipNextToken=!0)}},_defineObjectVar:function(){var e=this.parentList[this.parentList.length-1],t=e.scope.vars[this.currName];if(this.nextToken(),t){var r=new Expression.Var(this.currName,parentList);r.expr=this.parseExpression(),r.expr=this.optimizer.do(r.expr),r.var=t,r.analyse(),this.scope.vars[this.currName]=r,this.scope.varBuffer.push(r)}else{t=new Expression.Var(this.currName,parentList),t.var=t,e.scope.vars[this.currName]=t,e.scope.defBuffer.push(t);var r=new Expression.Var(this.currName,parentList);r.expr=this.parseExpression(),r.expr=this.optimizer.do(r.expr),r.var=t,r.analyse(),this.scope.varBuffer.push(r),t.type=r.type}},parseObject:function(){var e="";e=this.scope===this.global?this.currName:"__Sanonym"+this.genID++ +"__",this.scope.vars[e]&&dopple.throw(dopple.Error.REDEFINITION,e);var t=this.scope;this.scope=new dopple.Scope(this.scope);var r=new Expression.Object(e,this.scope);t.vars[e]=r,t.defBuffer.push(r),this.parentList=[r];var s=new Expression.Function("__init",this.scope,null,this.parentList);this.scope.vars.__init=s,t.defBuffer.push(s);var i=new Expression.FunctionCall(s);t.varBuffer.push(i);var n,o,p;for(this.nextToken();"}"!==this.token.str;)this.token.type===this.tokenEnum.NAME||this.token.type===this.tokenEnum.STRING?(this.currName=this.token.str,this.nextToken(),":"!==this.token.str&&this.handleTokenError(),this.nextToken(),p=this.parseExpression(),p=this.optimizer.do(p),p.exprType===this.exprEnum.OBJECT&&dopple.throw(dopple.Error.UNSUPPORTED_FEATURE,"object inside an object"),","!==this.token.str&&"}"!==this.token.str&&this.handleTokenError(),"}"!==this.token.str&&(","!==this.token.str?(this.validateToken(),this.nextToken(),"}"!==this.token.str&&this.handleTokenError()):this.nextToken()),p.exprType!==this.exprEnum.FUNCTION&&(o=new Expression.Var(n,this.parentList),o.expr=p,o.analyse(),this.scope.vars[n]=o,this.scope.defBuffer.push(o),this.scope.varBuffer.push(o))):dopple.throw(dopple.Error.UNSUPPORTED_FEATURE,"hashmap");return this.nextToken(),this.scope=t,this._skipNextToken=!0,this.parentList=null,r},parseFunc:function(){this.nextToken();var e=this.currName,t="";this.token.type===this.tokenEnum.NAME&&(t=this.token.str,e||(e=t),this.nextToken()),e||t||this.handleUnexpectedToken(),"("!==this.token.str&&this.handleUnexpectedToken(),this.scope=new dopple.Scope(this.scope);var r,s=[];for(this.nextToken();this.token.type===Token.Type.NAME;){if(r=new Expression.Var(this.token.str),r.var=r,s.push(r),this.scope.vars[r.name]=r,this.nextToken(),","!==this.token.str){if(")"===this.token.str)break;this.handleUnexpectedToken()}this.nextToken()}")"!==this.token.str&&this.handleUnexpectedToken(),this.nextToken(),"{"!==this.token.str&&dopple.throw(dopple.Error.UNEXPECTED_EOI),this.parseBody(),"}"!==this.token.str&&dopple.throw(dopple.Error.UNEXPECTED_EOI);var i=new Expression.Function(e,this.scope,s,this.parentList);i.rootName=t,this.currName=e;var n=this.scope.parent;return n.vars[this.makeFuncName(this.currName)]=i,this.global.defBuffer.push(i),this.scope=this.scope.parent,this.nextToken(),this._skipNextToken=!0,i},parseFuncCall:function(){var e=this.getFunc(),t=0,r=new Array(e.numParams),s,i,n=e.params,o=n.length;if(this.nextToken(),")"!==this.token.str)for(;;t++){if(t>=o&&dopple.throw(dopple.Error.TOO_MANY_ARGUMENTS),i=this.parseExpression(),i=this.optimizer.do(i),i.analyse(),r[t]=i,s=n[t],0===s.type&&(s.type=i.type),","!==this.token.str){t++;break}this.nextToken()}for(;o>t;t++)r[t]=n[t];var p=new Expression.FunctionCall(e,r);this.scope.varBuffer.push(p)},parseReturn:function(){var e=null,t=Token.Type;if(this.nextToken(),this.token.type===t.VAR||this.token.type===t.NUMBER||this.token.type===t.STRING){var r=new Expression.Var("");r.expr=this.parseExpression(),r.expr=this.optimizer.do(r.expr),r.var=r.expr,r.analyse()}var s=new Expression.Return(r);this.scope.varBuffer.push(s)},parseParentList:function(){this.parentList=[];do{this.nextToken(),this.token.type!==this.tokenEnum.NAME&&this.handleTokenError();var e=this.getExprFromVar(this.scope,this.currName);this.parentList.push(e),this.currName=this.token.str,this.nextToken()}while("."===this.token.str)},getExprFromVar:function(e,t){var r=e.vars[t];return r||dopple.throw(dopple.Error.REFERENCE_ERROR,t),r},getFunc:function(){var e=null;if(this.parentList){var t=this.parentList.length;if(0>=t)e=this.global.vars[this.currName];else{for(var r="",s=0;t>s;s++)r+=this.parentList[s].name+"$";r+=this.currName;var i=this.parentList[t-1];e=i.scope.vars[r]}}else e=this.global.vars[this.currName];return e||dopple.throw(dopple.Error.REFERENCE_ERROR,r),e},makeFuncName:function(){if(!this.parentList)return this.currName;var e=this.parentList.length;if(0>=e)return this.currName;for(var t="",r=0;e>r;r++)t+=this.parentList[r].name+"$";return t+=this.currName,t},externFunc:function(e,t){var r=null;if(t){r=[];for(var s,i,n,o=t.length,p=0;o>p;p+=2)n=t[p],n===this.varEnum.NUMBER?i=new Expression.Number(0):n===this.varEnum.STRING?i=new Expression.String(""):n===this.varEnum.STRING_OBJ&&(i=new Expression.StringObj("")),s=new Expression.Var(t[p+1]),s.type=n,s.var=i,r.push(s)}var h=new Expression.Function(e,this.global,r);this.global.vars[e]=h},externObj:function(e){var t=new Expression.Object(e);return this.global.vars[e]=t,t},validateToken:function(){this.token.type===this.tokenEnum.EOF?dopple.throw(dopple.Error.UNEXPECTED_EOI):this.token.type===this.tokenEnum.NUMBER?dopple.throw(dopple.Error.UNEXPECTED_NUMBER):"@"===this.token.str?dopple.throw(dopple.Error.UNEXPECTED_TOKEN_ILLEGAL):this.token.type!==this.tokenEnum.SYMBOL&&dopple.throw(dopple.Error.UNEXPECTED_ID)},handleTokenError:function(){this.validateToken(),dopple.throw(dopple.Error.UNEXPECTED_TOKEN,this.token.str)},handleUnexpectedToken:function(){isIllegal(this.token.str)?dopple.throw(dopple.Error.UNEXPECTED_TOKEN_ILLEGAL):dopple.throw(dopple.Error.UNEXPECTED_TOKEN,this.token.str)}},dopple.Scope=function(e){this.parent=e||null,this.vars={},this.defBuffer=[],this.varBuffer=[]},"use strict",Optimizer.prototype={do:function(e){return e?e.exprType!==Expression.Type.BINARY?e:e.lhs||e.rhs?this._doExpr(e):e:e},_doExpr:function(e){var t=e.lhs.exprType,r=e.rhs.exprType;if(t===this.exprEnum.BINARY&&(e.lhs=this._doExpr(e.lhs),t=e.lhs.exprType),r===this.exprEnum.BINARY&&(e.rhs=this._doExpr(e.rhs),r=e.rhs.exprType),t!==this.exprEnum.NUMBER&&t!==this.exprEnum.STRING_OBJ||r!==this.exprEnum.NUMBER&&r!==this.exprEnum.STRING_OBJ)return e;var s,i=e.op;return"+"===i?s=e.lhs.value+e.rhs.value:"-"===i?s=e.lhs.value-e.rhs.value:"*"===i?s=e.lhs.value*e.rhs.value:"/"===i&&(s=e.lhs.value/e.rhs.value),"string"==typeof s?new Expression.StringObj(s):new Expression.Number(s)}},"use strict";var Expression={};Expression.Base=function(e){this.type=0,this.exprType=e||0},Expression.Base.prototype={analyse:function(){},to:function(e){return"void"},strType:function(){var e=Variable.Type;for(var t in e)if(e[t]===this.type)return t;return""},strExprType:function(){var e=Variable.Type;for(var t in Expression.Type)if(e[t]===this.exprType)return t;return""}},Expression.Type={VOID:0,VAR:1,NUMBER:2,BOOL:3,STRING:4,STRING_OBJ:5,BINARY:6,FUNCTION:7,FUNCTION_CALL:8,PROTOTYPE:9,OBJECT:10,RETURN:11};var Variable={Type:{VOID:0,NUMBER:1,BOOL:2,STRING:3,STRING_OBJ:4,OBJECT:5,FORMAT:6,ARGUMENTS:7,SCOPE:8}};"use strict",Expression.Number=function(e){this.value=e,this.type=Variable.Type.NUMBER},Expression.Number.prototype=new Expression.Base(Expression.Type.NUMBER),Expression.Number.prototype.castTo=function(e){if(this.type===e.type)return this.value;var t=Variable.Type;return e.type===t.STRING?'"'+this.value+'"':e.type===t.STRING_OBJ?'"'+e.var.hexLength(this.value)+'""'+this.value+'"':(dopple.throw(dopple.Error.INVALID_TYPE_CONVERSION,this),void 0)},Expression.Number.prototype.defaultValue=function(){return"NaN"},"use strict",Expression.Bool=function(e){this.value=1*e,this.type=Variable.Type.BOOL},Expression.Bool.prototype=new Expression.Base(Expression.Type.BOOL),"use strict",Expression.String=function(e){this.value=e||"",this.type=Variable.Type.STRING},Expression.String.prototype=new Expression.Base(Expression.Type.STRING),Expression.String.prototype.defaultValue=function(){return'"undefined"'},"use strict",Expression.StringObj=function(e){this.value=e||"",this.type=Variable.Type.STRING_OBJ,this.length=this.hexLength(e.length)},Expression.StringObj.prototype=new Expression.Base(Expression.Type.STRING_OBJ),Expression.StringObj.prototype.castTo=function(e){if(this.type===e.type)return'"'+this.length+'""'+this.value+'"';var t=Variable.Type;if(e.type===t.NUMBER){var r=Number(this.value)||-1;return r}return e.type===t.STRING?'"'+this.value+'"':(dopple.throw(dopple.Error.INVALID_TYPE_CONVERSION,'"'+e.name+'" from '+this.strType()+" to "+e.strType()),void 0)},Expression.StringObj.prototype.defaultValue=function(){return'"\\x9\\x0\\x0\\x0""undefined"'},Expression.StringObj.prototype.hexLength=function(e){return ToHex(e)+"\\x0\\x0\\x0"},"use strict",Expression.Var=function(e,t){this.name=e||"",this.expr=null,this.var=null,this.value="",this.parentList=t||null},Expression.Var.prototype=new Expression.Base(Expression.Type.VAR),Expression.Var.prototype.castTo=function(e){if(this.type===e.type)return this.value;var t=Variable.Type;return e.type===t.STRING?this.type===t.STRING_OBJ?this.value+" + sizeof(int32_t)":this.value:(dopple.throw(dopple.Error.INVALID_TYPE_CONVERSION,'"'+e.name+'" from '+this.strType()+" to "+e.strType()),void 0)},Expression.Var.prototype.defaultValue=function(){var e=Variable.Type;if(0===this.type||this.type===e.NUMBER)return"NaN";if(this.type===e.STRING)return'"undefined"';if(this.type===e.STRING_OBJ)return'"\\x9\\x0\\x0\\x0""undefined"';throw"Expression.Var.defaultValue: Invalid conversion."},Expression.Var.prototype.analyse=function(){this.expr&&(0!==this.type&&this.type!==this.expr.type&&Error.throw(Error.Type.INVALID_TYPE_CONVERSION,'"'+this.var.name+'" '+this.var.strType()+" to "+this.expr.strType()),this.type=this.expr.type)},"use strict",Expression.Binary=function(e,t,r){this.op=e,this.lhs=t,this.rhs=r},Expression.Binary.prototype=new Expression.Base(Expression.Type.BINARY),Expression.Binary.prototype.analyse=function(){var e;e=binExpr.lhs.exprType===Expression.Type.BINARY?this.analyseBinExpr(binExpr.lhs):binExpr.lhs.type;var t;if(t=binExpr.rhs.exprType===Expression.Type.BINARY?this.analyseBinExpr(binExpr.rhs):binExpr.rhs.type,e!==t){if(e===Variable.Type.STRING_OBJ||t===Variable.Type.STRING_OBJ)return Variable.Type.STRING_OBJ;Lexer.throw(Lexer.Error.INVALID_TYPE_CONVERSION,'"'+this.var.name+'" '+binExpr.lhs.strType()+" to "+binExpr.rhs.strType())}this.type=e},"use strict",Expression.Function=function(e,t,r,s){this.name=e,this.type=Variable.Type.FUNCTION,this.scope=t,this.params=r,this.numParams=r?r.length:0,this.rootName=null,this.returnVar=new Expression.Var(""),this.parentList=s||null},Expression.Function.prototype=new Expression.Base(Expression.Type.FUNCTION),"use strict",Expression.FunctionCall=function(e,t){this.func=e,this.args=t||null},Expression.FunctionCall.prototype=new Expression.Base(Expression.Type.FUNCTION_CALL),"use strict",Expression.Return=function(e){this.expr=e},Expression.Return.prototype=new Expression.Base(Expression.Type.RETURN),"use strict",Expression.Object=function(e,t){this.name=e,this.str="[object Object]",this.type=Variable.Type.OBJECT,this.scope=t,this.isStatic=!0,this.init()},Expression.Object.prototype=new Expression.Base(Expression.Type.OBJECT),Expression.Object.prototype.init=function(){var e=new dopple.Scope(this.scope);this.constructFunc=new Expression.Function(this.name,e,[])},"use strict",Compiler.prototype={createLexer:function(){this.lexer=new Lexer,this.lexer.externFunc("alert",[Variable.Type.STRING_OBJ,"str"]),this.lexer.externFunc("confirm",[Variable.Type.STRING_OBJ,"str"])},compile:function(e){return this.lexer.read(e)?this.make():""},make:function(){this.output='#include "dopple.h"\n\n',this.define(this.global),this.output+="\nint main(int argc, char *argv[]) \n{\n",this.incTabs();var e,t=this.lexer.global.varBuffer,r=t.length;if(r){var s,i,n=Expression.Type;for(e=0;r>e;e++)s=t[e],i=s.exprType,i===n.VAR?this.makeVar(s):i===n.FUNCTION?this.output+=this.tabs+this.makeFunction(s):i===n.FUNCTION_CALL&&this.makeFuncCall(s);this.output+="\n"}return this.output+=this.tabs+"return 0;\n",this.output+="}\n",this.output},define:function(e){this.scope=e;var t,r,s,i=e.defBuffer,n=i.length;if(n){var o=i[0].exprType;for(t=0;n>t;t++)r=i[t],s=r.exprType,s!==o&&(this.output+="\n"),s===this.exprEnum.VAR?this.defineVar(r):s===this.exprEnum.FUNCTION?(this.defineFunc(r),s=0):s===this.exprEnum.FUNCTION_CALL?this.defineFuncCall(r):s===this.exprEnum.OBJECT?(this.defineObject(r),s=0):s===this.exprEnum.RETURN?this.defineReturn(r):console.log("unhandled"),o=s}var p=e.varBuffer,h=p.length;if(h)for(t=0;h>t;t++)if(r=p[t],s=r.exprType,s===this.exprEnum.VAR){if(r.parentList)continue;this.makeVar(r)}else s===this.exprEnum.RETURN&&this.defineReturn(r)},defineVar:function(e){if(e.type===Variable.Type.VOID)return console.warn("[Compiler.makeVar]:",'Variable "'+this.makeVarName(e)+'" is discarded - void type.'),void 0;this.output+=this.tabs;var t=e.expr;if(t){var r=t.exprType;e.parentList?r===this.exprEnum.VAR?this.output+=this.makeVarName(t)+t.name+";\n":r===this.exprEnum.STRING_OBJ?this.output+=this.makeVarName(e)+' = "'+t.length+'""'+t.value+'";\n':(this.output+=this.makeVarName(e)+" = ",this.defineExpr(t),this.output+=";\n"):r===this.exprEnum.VAR?this.output+=this.scope===this.global?this.varMap[e.type]+e.name+";\n":this.varMap[e.type]+e.name+" = "+t.name+";\n":r===this.exprEnum.STRING_OBJ?this.output+=this.varMap[e.type]+e.name+' = "'+t.length+'""'+t.value+'";\n':this.scope===this.global&&e.expr.exprType===Expression.Type.BINARY?this.output+=this.varMap[e.type]+e.name+";\n":(this.output+=this.varMap[e.type]+e.name+" = ",this.defineExpr(t),this.output+=";\n")}else this.output+=this.makeVarName(e)+" = "+e.defaultValue()+";\n"},defineExpr:function(e){var t=e.exprType,r=Expression.Type;t===r.NUMBER||t===r.VAR?this.output+=e.value:t===r.BINARY&&(this.defineExpr(e.lhs),this.output+=" "+e.op+" ",this.defineExpr(e.rhs))},defineFunc:function(e){var t=e.params,r=0;if(t&&(r=t.length),this.output+=this.varMap[e.returnVar.type]+this.makeFuncName(e)+"(",r){for(var s,i=0;r-1>i;i++)s=t[i],this.output+=0!==s.type?this.varMap[s.type]+s.name+", ":"double "+s.name+", ";s=t[i],this.output+=0!==s.type?this.varMap[s.type]+s.name:"double "+s.name}this.output+=") \n{\n",this.incTabs(),this.define(e.scope),this.decTabs(),this.output+="}\n"},defineObject:function(e){var t=e.scope.defBuffer,r=t.length;this.output+="static struct {\n",this.incTabs();for(var s,i=0;r>i;i++)s=t[i],s.type>0&&(this.output+=this.tabs+this.varMap[s.type]+s.name+";\n");this.decTabs(),this.output+="} "+e.name+";\n"},defineReturn:function(e){this.output+=this.tabs,e.expr?(this.output+="return ",this.defineExpr(e.expr),this.output+=";\n"):this.output+="return;\n"},makeVar:function(e){if(e.type===Variable.Type.VOID)return console.warn("[Compiler.makeVar]:",'Variable "'+e.name+'" is discarded - void type.'),"";this.output+=this.tabs+this.makeVarName(e)+" = ";var t=Expression.Type,r=e.expr;this.output+=r.exprType===t.NUMBER?r.value:r.exprType===t.VAR?r.name:r.exprType===t.STRING_OBJ?'"'+r.length+'""'+r.value+'"':r.exprType===t.BINARY?this._makeVarBinary(r):r.value,this.output+=";\n"},makeVarExpr:function(e){if(e.type===Variable.Type.VOID)return console.warn("[Compiler.makeVar]:",'Variable "'+e.name+'" is discarded - void type.'),"";var t=Expression.Type,r=e.name+" = ",s=e.expr;return s.exprType===t.NUMBER?r+=s.value+";\n":s.exprType===t.VAR?r+=s.value+";\n":s.exprType===t.STRING_OBJ?r+='"'+s.value+'";\n':s.exprType===t.BINARY&&(r+=this._makeVarBinary(s)+";\n"),r},_makeVarBinary:function(e){var t;t=e.lhs.exprType===Expression.Type.BINARY?this._makeVarBinary(e.lhs):e.lhs.type===Variable.Type.STRING_OBJ?'"'+e.lhs.str+'"':e.lhs.value;var r;return r=e.rhs.exprType===Expression.Type.BINARY?this._makeVarBinary(e.rhs):e.rhs.type===Variable.Type.STRING?'"'+e.rhs.str+'"':e.rhs.value,t+" "+e.op+" "+r},makeFuncCall:function(e){var t=e.func.params,r=e.args,s=e.func.numParams;if(this.output+=this.tabs+this.makeFuncName(e.func)+"(",s>0){var i=r[0],n=t[0];this.output+=i===n?n.var.defaultValue():i.castTo(n);for(var o=1;s>o;o++)this.output+=", ",i=r[o],n=t[o],this.output+=i===n?n.var.defaultValue():i.castTo(n)}this.output+=");\n"},makeVarName:function(e){var t=e.parentList;if(!t)return e.name;var r=t.length;if(0>=r)return e.name;for(var s="",i=0;r>i;i++)s+=t[i].name+".";return s+=e.name,s},makeFuncName:function(e){var t=e.parentList;if(!t)return e.name;var r=t.length;if(0>=r)return e.name;for(var s="",i=0;r>i;i++)s+=t[i].name+"$";return s+=e.name,s},incTabs:function(){this.tabs+="	"},decTabs:function(){this.tabs=this.tabs.substr(0,this.tabs.length-1)}};